<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComplianceConnect</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll if content fits */
        }
        /* Убедитесь, что основная область контента прокручивается при необходимости */
        main {
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react.development.js"></script>
    <!-- Babel для преобразования JSX в браузере -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (v10.x.x, как указано в инструкциях) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Делаем Firebase доступным в глобальной области видимости для Babel
        window.firebase = {
            initializeApp: initializeApp,
            getAuth: getAuth,
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            onAuthStateChanged: onAuthStateChanged,
            signOut: signOut,
            createUserWithEmailAndPassword: createUserWithEmailAndPassword,
            signInWithEmailAndPassword: signInWithEmailAndPassword,
            getFirestore: getFirestore,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            collection: collection,
            query: query,
            where: where,
            getDocs: getDocs
        };
    </script>

    <!-- Ваш код приложения React -->
    <script type="text/babel">
        // ВАЖНО: Если вы запускаете этот файл HTML ЛОКАЛЬНО (не в среде Canvas),
        // вам нужно заменить __app_id и __firebase_config своими реальными данными Firebase.
        // Вы можете найти их в консоли Firebase вашего проекта (Настройки проекта -> Общие).
        //
        // Пример:
        // const __app_id = 'your-firebase-project-id';
        // const __firebase_config = JSON.stringify({
        //     apiKey: "YOUR_API_KEY",
        //     authDomain: "YOUR_AUTH_DOMAIN",
        //     projectId: "YOUR_PROJECT_ID",
        //     storageBucket: "YOUR_STORAGE_BUCKET",
        //     messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //     appId: "YOUR_APP_ID",
        //     measurementId: "YOUR_MEASUREMENT_ID"
        // });
        //
        // Если вы видите 'Загрузка...' или 'Аутентификация не удалась', это, скорее всего,
        // связано с неправильной или отсутствующей конфигурацией Firebase.
        // Оставьте эти строки, как есть, если вы запускаете это в среде Canvas,
        // так как они будут предоставлены автоматически.

        // ВСТАВЬТЕ СЮДА ВАШИ ДАННЫЕ FIREBASE И УБЕДИТЕСЬ, ЧТО ОНИ ВЕРНЫЕ ИЗ КОНСОЛИ FIREBASE:
        // СТРОКИ НИЖЕ РАСКОММЕНТИРОВАНЫ. ВАМ НУЖНО ТОЛЬКО ЗАМЕНИТЬ ЗНАЧЕНИЯ 'YOUR_...'
        //
        // *** ОСОБОЕ ВНИМАНИЕ НА apiKey: УБЕДИТЕСЬ, ЧТО ОН НАЧИНАЕТСЯ С "AIzaSy" И БЕЗ ЛИШНИХ СИМВОЛОВ! ***
        //
        const __app_id = 'complianceconnect-design'; // Пример: 'my-project-12345'
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDr-M6dm-1yPObvAVwreIlxRUEAUrkoj94", // Например: "AIzaSyC..." <-- УБЕДИТЕСЬ, ЧТО ЗДЕСЬ НЕТ "Y" ИЛИ ДРУГИХ ЛИШНИХ СИМВОЛОВ ПЕРЕД "AIzaSy"
            authDomain: "complianceconnect-design.firebaseapp.com", // Например: "my-project-12345.firebaseapp.com"
            projectId: "complianceconnect-design", // Пример: "my-project-12345"
            storageBucket: "complianceconnect-design.firebasestorage.app", // Например: "my-project-12345.appspot.com"
            messagingSenderId: "759186517452", // Например: "123456789012"
            appId: "1:759186517452:web:07250310b7ecb5b13a8169", // Например: "1:123456789012:web:abcdef1234567890abcdef"
            measurementId: "G-L7PCZ3ECYS" // Например: "G-XXXXXXXXXX"
        });


        const { useState, useEffect, createContext, useContext } = React;
        const { createRoot } = ReactDOM;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } = window.firebase;

        // Context для Firebase и аутентификации
        const FirebaseContext = createContext(null);

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [currentPage, setCurrentPage] = useState('login'); // Страница по умолчанию - вход
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showProfilePopup, setShowProfilePopup] = useState(false);
            const [showLoginPopup, setShowLoginPopup] = useState(true); // Показывать всплывающее окно входа изначально

            // Состояния для детализированной навигации
            const [selectedCategoryId, setSelectedCategoryId] = useState(null);
            const [selectedCategoryName, setSelectedCategoryName] = useState(null);
            const [selectedDocumentCategoryId, setSelectedDocumentCategoryId] = useState(null);
            const [selectedDocumentCategoryName, setSelectedDocumentCategoryName] = useState(null);
            const [selectedDocumentTypeId, setSelectedDocumentTypeId] = useState(null);
            const [selectedDocumentTypeName, setSelectedDocumentTypeName] = useState(null);

            // Состояние для общего модального сообщения (замена alert)
            const [showGenericMessageModal, setShowGenericMessageModal] = useState(false);
            const [genericMessageTitle, setGenericMessageTitle] = useState('');
            const [genericMessageContent, setGenericMessageContent] = useState('');

            const displayMessage = (title, content) => {
                setGenericMessageTitle(title);
                setGenericMessageContent(content);
                setShowGenericMessageModal(true);
            };


            // Инициализация Firebase и настройка слушателя аутентификации
            useEffect(() => {
                try {
                    let appIdValue = 'default-app-id';
                    let firebaseConfigObject = {};
                    let firebaseConfigString = '';

                    // Проверка и логирование __app_id
                    if (typeof __app_id !== 'undefined' && __app_id !== 'complianceconnect-design') {
                        appIdValue = __app_id;
                        console.log("Используемый appId:", appIdValue);
                    } else {
                        console.warn("Переменная __app_id не определена или содержит значение по умолчанию. Убедитесь, что вы ее правильно установили (ваш projectId).");
                    }

                    // Проверка и логирование __firebase_config
                    // Мы ожидаем, что __firebase_config уже является строкой JSON благодаря JSON.stringify()
                    if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{"apiKey":"AIzaSyDr-M6dm-1yPObvAVwreIlxRUEAUrkoj94","authDomain":"complianceconnect-design.firebaseapp.com","projectId":"complianceconnect-design","storageBucket":"complianceconnect-design.firebasestorage.app","messagingSenderId":"759186517452","appId":"1:759186517452:web:07250310b7ecb5b13a8169","measurementId":"G-L7PCZ3ECYS"}') {
                        firebaseConfigString = __firebase_config;
                        console.log("Исходная строка __firebase_config:", firebaseConfigString);
                        try {
                            firebaseConfigObject = JSON.parse(firebaseConfigString);
                            console.log("Распарсенный firebaseConfigObject:", firebaseConfigObject); // Логируем распарсенный объект
                        } catch (parseError) {
                            console.error("Ошибка при парсинге __firebase_config:", parseError);
                            setError(`Ошибка конфигурации Firebase: Невозможно распарсить JSON. Убедитесь, что строка __firebase_config правильно отформатирована (без лишних символов, правильные кавычки).`);
                            setLoading(false);
                            return;
                        }
                    } else {
                        console.warn("Переменная __firebase_config не определена или содержит значения по умолчанию. Убедитесь, что вы ее правильно установили.");
                    }


                    // Дополнительная проверка на наличие обязательных свойств конфигурации
                    if (!firebaseConfigObject.apiKey || !firebaseConfigObject.authDomain || !firebaseConfigObject.projectId) {
                        const missingParts = [];
                        if (!firebaseConfigObject.apiKey) missingParts.push('apiKey');
                        if (!firebaseConfigObject.authDomain) missingParts.push('authDomain');
                        if (!firebaseConfigObject.projectId) missingParts.push('projectId');
                        const errorMessage = `Неполная конфигурация Firebase. Отсутствуют: ${missingParts.join(', ')}. Пожалуйста, убедитесь, что вы правильно вставили все данные из вашей консоли Firebase.`;
                        console.error(errorMessage);
                        setError(errorMessage); // Устанавливаем более информативное сообщение об ошибке
                        setLoading(false);
                        return; // Остановить выполнение, если конфигурация неверна
                    }

                    console.log("Firebase config object used for initialization:", firebaseConfigObject); // Повторный лог перед инициализацией

                    const app = initializeApp(firebaseConfigObject);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestoreDb);
                    setAuth(firebaseAuth);

                    const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setUserEmail(user.email);
                            // Проверка, является ли пользователь администратором
                            const userDocRef = doc(firestoreDb, `artifacts/${appIdValue}/users/${user.uid}/profile`, 'data');
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists()) {
                                setIsAdmin(userDocSnap.data().isAdmin || false);
                                setCurrentPage('dashboard'); // Перейти на дашборд после входа
                            } else {
                                // Для вновь вошедших пользователей создать документ профиля
                                await setDoc(userDocRef, {
                                    firstName: '',
                                    lastName: '',
                                    email: user.email,
                                    isAdmin: false,
                                });
                                setIsAdmin(false);
                                setCurrentPage('dashboard');
                            }
                            setShowLoginPopup(false); // Скрыть всплывающее окно входа после успешной аутентификации
                        } else {
                            setUserId(null);
                            setUserEmail(null);
                            setIsAdmin(false);
                            setCurrentPage('login'); // Перейти на страницу входа после выхода
                            setShowLoginPopup(true); // Показать всплывающее окно входа
                        }
                        setIsAuthReady(true);
                        setLoading(false);
                    });

                    // Попытка войти с помощью пользовательского токена, если доступно
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken && firebaseAuth && !firebaseAuth.currentUser) {
                        signInWithCustomToken(firebaseAuth, initialAuthToken)
                            .then(() => {
                                console.log("Вход выполнен с пользовательским токеном.");
                                // setShowLoginPopup(false) уже управляется слушателем onAuthStateChanged
                            })
                            .catch((error) => {
                                console.error("Ошибка входа с пользовательским токеном:", error);
                                // Если пользовательский токен не работает, попробовать анонимный вход или оставить всплывающее окно входа открытым
                                signInAnonymously(firebaseAuth).then(() => {
                                    console.log("Вход выполнен анонимно.");
                                    // setShowLoginPopup(false) уже управляется слушателем onAuthStateChanged
                                }).catch((anonError) => {
                                    console.error("Ошибка анонимного входа:", anonError);
                                    setError("Аутентификация не удалась. Пожалуйста, попробуйте еще раз.");
                                    setShowLoginPopup(true);
                                });
                            });
                    } else if (!firebaseAuth.currentUser) {
                        // Если нет пользовательского токена и пользователь еще не вошел, попробовать анонимный вход
                        signInAnonymously(firebaseAuth).then(() => {
                            console.log("Вход выполнен анонимно.");
                            // setShowLoginPopup(false) уже управляется слушателем onAuthStateChanged
                        }).catch((anonError) => {
                            console.error("Ошибка анонимного входа:", anonError);
                            setError("Аутентификация не удалась. Пожалуйста, попробуйте еще раз.");
                            setShowLoginPopup(true);
                        });
                    }

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Ошибка инициализации Firebase:", e);
                    setError("Ошибка инициализации приложения.");
                    setLoading(false);
                }
            }, []);

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setCurrentPage('login');
                    setShowLoginPopup(true);
                } catch (error) {
                    console.error("Ошибка выхода:", error);
                    setError("Ошибка выхода.");
                }
            };

            const handleLogin = async (email, password) => {
                setLoading(true);
                setError(null);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // setShowLoginPopup(false) и setCurrentPage('dashboard') управляются onAuthStateChanged
                } catch (error) {
                    console.error("Ошибка входа:", error);
                    setError("Неверный адрес электронной почты или пароль.");
                } finally {
                    setLoading(false);
                }
            };

            const toggleProfilePopup = () => {
                setShowProfilePopup(!showProfilePopup);
            };

            const setPageAndSelection = (page, categoryId = null, categoryName = null, docCategoryId = null, docCategoryName = null, docTypeId = null, docTypeName = null) => {
                setCurrentPage(page);
                setSelectedCategoryId(categoryId);
                setSelectedCategoryName(categoryName);
                setSelectedDocumentCategoryId(docCategoryId);
                setSelectedDocumentCategoryName(docCategoryName);
                setSelectedDocumentTypeId(docTypeId);
                setSelectedDocumentTypeName(docTypeName);
            };

            if (loading || !isAuthReady) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-xl text-gray-700">Загрузка...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-red-100 text-red-700">
                        <div className="text-xl">{error}</div>
                    </div>
                );
            }

            return (
                <FirebaseContext.Provider value={{ db, auth, userId, isAdmin, userEmail }}>
                    <div className="flex min-h-screen font-inter">
                        {/* Боковое меню */}
                        <div className="w-64 bg-blue-800 text-white p-4 flex flex-col rounded-r-lg shadow-lg">
                            <div className="flex items-center mb-6">
                                <img src="https://placehold.co/40x40/ffffff/000000?text=CC" alt="Логотип Compliance Connect" className="rounded-full mr-3" />
                                <h1 className="text-2xl font-bold">Compliance Connect</h1>
                            </div>
                            <nav className="flex-grow">
                                <ul>
                                    <SidebarMenuItem icon="📊" label="Панель приборов" page="dashboard" currentPage={currentPage} setCurrentPage={setPageAndSelection} />
                                    <SidebarMenuItem icon="🗂️" label="Категории" page="categories" currentPage={currentPage} setCurrentPage={setPageAndSelection} />
                                    <SidebarMenuItem icon="📄" label="Документы" page="documents" currentPage={currentPage} setCurrentPage={setPageAndSelection} />
                                    {isAdmin && <SidebarMenuItem icon="👥" label="Пользователи" page="users" currentPage={currentPage} setCurrentPage={setPageAndSelection} />}
                                </ul>
                            </nav>
                            <div className="mt-auto text-sm text-center opacity-75">
                                <p>Ваш ID: {userId}</p>
                            </div>
                        </div>

                        {/* Основная область контента */}
                        <div className="flex-1 flex flex-col bg-gray-100 rounded-l-lg shadow-inner">
                            {/* Заголовок */}
                            <header className="bg-white p-4 border-b border-gray-200 flex justify-between items-center rounded-tr-lg">
                                <h2 className="text-xl font-semibold text-gray-800">
                                    {currentPage === 'dashboard' && 'Панель приборов'}
                                    {currentPage === 'categories' && 'Категории'}
                                    {currentPage === 'documents' && 'Документы'}
                                    {currentPage === 'users' && 'Пользователи'}
                                    {currentPage === 'tasks' && `Задачи: ${selectedCategoryName || ''}`}
                                    {currentPage === 'documentTypes' && `Типы документов: ${selectedDocumentCategoryName || ''}`}
                                    {currentPage === 'documentArchive' && `Архив документов: ${selectedDocumentTypeName || ''}`}
                                </h2>
                                {userEmail && (
                                    <div className="relative">
                                        <button
                                            onClick={toggleProfilePopup}
                                            className="text-blue-700 font-medium hover:text-blue-900 focus:outline-none"
                                        >
                                            Добро пожаловать, {userEmail}!
                                        </button>
                                        {showProfilePopup && (
                                            <ProfilePopup
                                                onClose={toggleProfilePopup}
                                                onLogout={handleLogout}
                                                userId={userId}
                                            />
                                        )}
                                    </div>
                                )}
                            </header>

                            {/* Контент */}
                            <main className="flex-1 p-6 overflow-auto">
                                {currentPage === 'login' && showLoginPopup && (
                                    <LoginPopup onLogin={handleLogin} error={error} onClose={() => setShowLoginPopup(false)} />
                                )}
                                {currentPage === 'dashboard' && !showLoginPopup && <Dashboard displayMessage={displayMessage} />}
                                {currentPage === 'categories' && !showLoginPopup && <Categories setCurrentPage={setPageAndSelection} displayMessage={displayMessage} />}
                                {currentPage === 'tasks' && !showLoginPopup && <Tasks selectedCategoryId={selectedCategoryId} selectedCategoryName={selectedCategoryName} setCurrentPage={setPageAndSelection} displayMessage={displayMessage} />}
                                {currentPage === 'documents' && !showLoginPopup && <Documents setCurrentPage={setPageAndSelection} />}
                                {currentPage === 'documentTypes' && !showLoginPopup && <DocumentTypes selectedDocumentCategoryId={selectedDocumentCategoryId} selectedDocumentCategoryName={selectedDocumentCategoryName} setCurrentPage={setPageAndSelection} displayMessage={displayMessage} />}
                                {currentPage === 'documentArchive' && !showLoginPopup && <DocumentArchive selectedDocumentTypeId={selectedDocumentTypeId} selectedDocumentTypeName={selectedDocumentTypeName} displayMessage={displayMessage} />}
                                {currentPage === 'users' && !showLoginPopup && <Users displayMessage={displayMessage} />}
                            </main>
                        </div>
                    </div>
                    <Modal
                        show={showGenericMessageModal}
                        title={genericMessageTitle}
                        message={genericMessageContent}
                        onClose={() => setShowGenericMessageModal(false)}
                        showCancel={false}
                    />
                </FirebaseContext.Provider>
            );
        };

        // Компонент пункта бокового меню
        const SidebarMenuItem = ({ icon, label, page, currentPage, setCurrentPage }) => {
            const isActive = currentPage === page;
            return (
                <li className="mb-2">
                    <button
                        onClick={() => setCurrentPage(page)}
                        className={`flex items-center w-full p-3 rounded-lg transition-all duration-200 ${isActive ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-blue-700 hover:text-white'}`}
                    >
                        <span className="mr-3 text-xl">{icon}</span>
                        <span>{label}</span>
                    </button>
                </li>
            );
        };

        // Компонент всплывающего окна входа
        const LoginPopup = ({ onLogin, error, onClose }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                await onLogin(email, password);
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
                        <div className="flex justify-center mb-6">
                            <img src="https://placehold.co/60x60/ffffff/000000?text=CC" alt="Логотип Compliance Connect" className="rounded-full mr-3 bg-blue-800" />
                            <h2 className="text-3xl font-bold text-blue-800">Compliance Connect</h2>
                        </div>
                        <h3 className="text-2xl font-semibold text-gray-700 mb-6 text-center">Вход</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
                                    Адрес электронной почты
                                </label>
                                <input
                                    type="email"
                                    id="email"
                                    className="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="janedoe@there.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                                    Пароль
                                </label>
                                <input
                                    type="password"
                                    id="password"
                                    className="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="**********"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            {error && <p className="text-red-500 text-xs italic mb-4 text-center">{error}</p>}
                            <div className="flex items-center justify-between mb-6">
                                <label className="flex items-center text-gray-700 text-sm">
                                    <input type="checkbox" className="form-checkbox h-4 w-4 text-blue-600 rounded" />
                                    <span className="ml-2">Запомнить меня</span>
                                </label>
                                <a href="#" className="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                                    Забыли пароль?
                                </a>
                            </div>
                            <button
                                type="submit"
                                className="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center"
                                disabled={isLoading}
                            >
                                {isLoading ? (
                                    <svg className="animate-spin h-5 w-5 text-white mr-3" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                ) : 'Войти'}
                            </button>
                            <button
                                type="button"
                                onClick={onClose}
                                className="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg w-full transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50"
                            >
                                Закрыть
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // Компонент всплывающего окна профиля
        const ProfilePopup = ({ onClose, onLogout, userId }) => {
            const { db, auth } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [firstName, setFirstName] = useState('');
            const [lastName, setLastName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [message, setMessage] = useState('');

            useEffect(() => {
                const fetchUserProfile = async () => {
                    if (db && userId) {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const data = userDocSnap.data();
                            setFirstName(data.firstName || '');
                            setLastName(data.lastName || '');
                            setEmail(data.email || auth.currentUser?.email || '');
                        } else {
                            setEmail(auth.currentUser?.email || '');
                        }
                    }
                };
                fetchUserProfile();
            }, [db, userId, auth, appId]);

            const handleSaveChanges = async () => {
                setMessage('');
                try {
                    if (db && userId && auth.currentUser) {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                        await setDoc(userDocRef, {
                            firstName,
                            lastName,
                            email,
                        }, { merge: true });

                        if (auth.currentUser.email !== email) {
                            // В реальном приложении для обновления электронной почты требуется повторная аутентификация
                            setMessage('Электронная почта обновлена. Для вступления в силу может потребоваться повторный вход.');
                        }
                        if (password) {
                            await auth.currentUser.updatePassword(password);
                            setMessage('Пароль обновлен.');
                        }
                        setMessage('Изменения сохранены!');
                    }
                } catch (error) {
                    console.error("Ошибка сохранения изменений профиля:", error);
                    setMessage(`Ошибка сохранения: ${error.message}`);
                }
            };

            return (
                <div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg py-4 z-10 border border-gray-200">
                    <button onClick={onClose} className="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                        <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 className="text-xl font-semibold text-gray-800 px-4 mb-4">Профиль</h3>
                    <div className="px-4">
                        <div className="mb-3">
                            <label className="block text-gray-700 text-sm font-bold mb-1">Имя</label>
                            <input
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={firstName}
                                onChange={(e) => setFirstName(e.target.value)}
                            />
                        </div>
                        <div className="mb-3">
                            <label className="block text-gray-700 text-sm font-bold mb-1">Фамилия</label>
                            <input
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={lastName}
                                onChange={(e) => setLastName(e.target.value)}
                            />
                        </div>
                        <div className="mb-3">
                            <label className="block text-gray-700 text-sm font-bold mb-1">Адрес электронной почты</label>
                            <input
                                type="email"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-1">Пароль</label>
                            <input
                                type="password"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                placeholder="**********"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                            />
                        </div>
                        {message && <p className="text-sm text-center mb-3 text-green-600">{message}</p>}
                        <button
                            onClick={handleSaveChanges}
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full mb-2 transition duration-200"
                        >
                            Сохранить изменения
                        </button>
                        <button
                            onClick={onLogout}
                            className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-200"
                        >
                            ВЫЙТИ
                        </button>
                    </div>
                </div>
            );
        };

        // Модальный компонент (общий)
        const Modal = ({ show, title, message, children, onClose, onConfirm, showCancel = true, confirmText = "ОК", cancelText = "Отмена" }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        {message && <p className="text-gray-700 mb-4">{message}</p>}
                        {children}
                        <div className="flex justify-end space-x-3 mt-4">
                            {showCancel && (
                                <button
                                    onClick={onClose}
                                    className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200"
                                >
                                    {cancelText}
                                </button>
                            )}
                            {onConfirm && (
                                <button
                                    onClick={onConfirm}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                >
                                    {confirmText}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Компонент панели управления
        const Dashboard = ({ displayMessage }) => {
            const { db, userId, isAdmin } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showConfirmDoneModal, setShowConfirmDoneModal] = useState(false);
            const [currentTaskToComplete, setCurrentTaskToComplete] = useState(null);
            const [confirmDoneMessage, setConfirmDoneMessage] = useState('');

            useEffect(() => {
                if (!db || !userId) return;

                // Прослушивание публичных данных для панели управления, предполагая, что задачи являются публичными или агрегированными
                const q = query(collection(db, `artifacts/${appId}/public/data/tasks`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedTasks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Сортировка на стороне клиента, так как orderBy() избегается согласно инструкциям
                    fetchedTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                    setTasks(fetchedTasks);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения задач:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, appId]);

            const handleUploadDoc = (taskId) => {
                displayMessage("Загрузка документа", "Функция загрузки документа не реализована в этой демонстрации. Представьте, что документ был загружен.");
            };

            const handleMarkAsDone = (task) => {
                setCurrentTaskToComplete(task);
                if (!task.documentAttached) { // Предполагаем поле `documentAttached` для простоты
                    setConfirmDoneMessage("Документ не прикреплен. Продолжить?");
                    setShowConfirmDoneModal(true);
                } else {
                    setConfirmDoneMessage("Эта задача будет отмечена как выполненная. Вы уверены?");
                    setShowConfirmDoneModal(true);
                }
            };

            const confirmTaskCompletion = async () => {
                setShowConfirmDoneModal(false);
                if (!currentTaskToComplete) return;

                try {
                    const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentTaskToComplete.id);
                    const originalDueDate = new Date(currentTaskToComplete.dueDate);
                    let newDueDate = new Date(originalDueDate);

                    // Обновление срока выполнения на основе частоты
                    switch (currentTaskToComplete.frequency) {
                        case 'Ежегодно':
                            newDueDate.setFullYear(newDueDate.getFullYear() + 1);
                            break;
                        case 'Ежеквартально':
                            newDueDate.setMonth(newDueDate.getMonth() + 3);
                            break;
                        case 'Каждые 3 года':
                            newDueDate.setFullYear(newDueDate.getFullYear() + 3);
                            break;
                        case 'Ежемесячно':
                            newDueDate.setMonth(newDueDate.getMonth() + 1);
                            break;
                        default:
                            newDueDate.setDate(newDueDate.getDate() + 30); // По умолчанию - ежемесячно, если частота неизвестна
                    }

                    // Устанавливаем 'done' в false, чтобы задача снова появилась для следующего срока
                    await updateDoc(taskDocRef, {
                        done: false, // Задача "выполнена" и переходит к следующему циклу
                        dueDate: newDueDate.toISOString().split('T')[0], // Формат ГГГГ-ММ-ДД
                    });

                    displayMessage("Статус выполнения задачи", "Эта задача была выполнена и перенесена на следующий цикл.");
                } catch (error) {
                    console.error("Ошибка при отметке задачи как выполненной:", error);
                    displayMessage("Ошибка выполнения задачи", `Ошибка при отметке задачи как выполненной: ${error.message}`);
                } finally {
                    setCurrentTaskToComplete(null);
                }
            };

            const filterTasks = (tasksList, days) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Нормализовать до начала дня

                return tasksList.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0); // Нормализовать до начала дня

                    const diffTime = dueDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (days === 'overdue') {
                        return diffDays < 0;
                    } else if (days === 30) {
                        return diffDays >= 0 && diffDays <= 30;
                    } else if (days === 90) {
                        return diffDays > 30 && diffDays <= 90;
                    }
                    return false;
                }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // Убедиться в сортировке по сроку
            };

            const overdueTasks = filterTasks(tasks, 'overdue');
            const dueNext30DaysTasks = filterTasks(tasks, 30);
            const dueNext90DaysTasks = filterTasks(tasks, 90);

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка задач...</div>;
            }

            return (
                <div className="space-y-6">
                    <Modal
                        show={showConfirmDoneModal}
                        title="Подтверждение выполнения задачи"
                        message={confirmDoneMessage}
                        onClose={() => setShowConfirmDoneModal(false)}
                        onConfirm={confirmTaskCompletion}
                        confirmText="Продолжить"
                        cancelText="Отмена"
                    />

                    {/* Просроченные задачи */}
                    <section className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold text-red-600 mb-4">Просроченные</h3>
                        {overdueTasks.length === 0 ? (
                            <p className="text-gray-600">Нет просроченных задач.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Задача</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Категория</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Срок</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Документ</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выполнено</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {overdueTasks.map((task) => (
                                            <tr key={task.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-700">{task.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.category}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-red-500 font-bold">{task.dueDate} <span className="text-red-700 ml-2">ПРОСРОЧЕНО</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                                    <button
                                                        onClick={() => handleUploadDoc(task.id)}
                                                        className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded-full text-xs"
                                                    >
                                                        {task.documentAttached ? 'Заменить PDF' : 'Прикрепить PDF'}
                                                    </button>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <input
                                                        type="checkbox"
                                                        checked={task.done}
                                                        onChange={() => handleMarkAsDone(task)}
                                                        className="form-checkbox h-5 w-5 text-blue-600 rounded-md"
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>

                    {/* Срок выполнения в следующие 30 дней */}
                    <section className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold text-blue-700 mb-4">Срок выполнения в следующие 30 дней</h3>
                        {dueNext30DaysTasks.length === 0 ? (
                            <p className="text-gray-600">Нет задач, срок выполнения которых истекает в следующие 30 дней.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Задача</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Категория</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Срок</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загрузить</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выполнено</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {dueNext30DaysTasks.map((task) => (
                                            <tr key={task.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{task.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.category}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.dueDate}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                                    <button
                                                        onClick={() => handleUploadDoc(task.id)}
                                                        className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded-full text-xs"
                                                    >
                                                        {task.documentAttached ? 'Заменить PDF' : 'Прикрепить PDF'}
                                                    </button>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <input
                                                        type="checkbox"
                                                        checked={task.done}
                                                        onChange={() => handleMarkAsDone(task)}
                                                        className="form-checkbox h-5 w-5 text-blue-600 rounded-md"
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>

                    {/* Срок выполнения в следующие 90 дней */}
                    <section className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold text-green-700 mb-4">Срок выполнения в следующие 90 дней</h3>
                        {dueNext90DaysTasks.length === 0 ? (
                            <p className="text-gray-600">Нет задач, срок выполнения которых истекает в следующие 90 дней.</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Задача</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Категория</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Срок</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загрузить</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выполнено</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {dueNext90DaysTasks.map((task) => (
                                            <tr key={task.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{task.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.category}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.dueDate}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                                    <button
                                                        onClick={() => handleUploadDoc(task.id)}
                                                        className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded-full text-xs"
                                                    >
                                                        {task.documentAttached ? 'Заменить PDF' : 'Прикрепить PDF'}
                                                    </button>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <input
                                                        type="checkbox"
                                                        checked={task.done}
                                                        onChange={() => handleMarkAsDone(task)}
                                                        className="form-checkbox h-5 w-5 text-blue-600 rounded-md"
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>
                </div>
            );
        };

        // Компонент категорий
        const Categories = ({ setCurrentPage, displayMessage }) => {
            const { db, userId } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [categories, setCategories] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [categoryToDelete, setCategoryToDelete] = useState(null);
            const [deleteMessage, setDeleteMessage] = useState('');
            const [showAddCategoryModal, setShowAddCategoryModal] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');

            useEffect(() => {
                if (!db || !userId) return;

                const unsubscribeCategories = onSnapshot(collection(db, `artifacts/${appId}/public/data/categories`), (snapshot) => {
                    const fetchedCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCategories(fetchedCategories);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения категорий:", error);
                    setLoading(false);
                });

                // Слушатель для задач, чтобы обновлять количество задач в категориях
                const unsubscribeTasks = onSnapshot(collection(db, `artifacts/${appId}/public/data/tasks`), (snapshot) => {
                    const allTasks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setCategories(prevCategories => {
                        return prevCategories.map(category => {
                            const tasksInCategory = allTasks.filter(task => task.category === category.name);
                            const tasksDue = tasksInCategory.filter(task => new Date(task.dueDate) < new Date()).length;
                            const tasksNext30Days = tasksInCategory.filter(task => {
                                const today = new Date();
                                const dueDate = new Date(task.dueDate);
                                const diffTime = dueDate.getTime() - today.getTime();
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                return diffDays >= 0 && diffDays <= 30;
                            }).length;

                            // Найти ближайший срок выполнения
                            const nextDueDateTask = tasksInCategory
                                .filter(task => new Date(task.dueDate) >= new Date()) // Только будущие или сегодняшние задачи
                                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
                            const nextDueDate = nextDueDateTask ? nextDueDateTask.dueDate : 'НЕТ';

                            return {
                                ...category,
                                tasksDue: tasksInCategory.length, // Общее количество задач в категории
                                tasksNext30Days: tasksNext30Days,
                                nextDueDate: nextDueDate,
                            };
                        });
                    });
                });

                return () => {
                    unsubscribeCategories();
                    unsubscribeTasks();
                };
            }, [db, userId, appId]);

            const handleDeleteCategoryClick = (category) => {
                setCategoryToDelete(category);
                if (category.tasksDue > 0) {
                    setDeleteMessage("Для удаления этой категории необходимо удалить все ее задачи.");
                    setShowDeleteModal(true);
                } else {
                    setDeleteMessage(`Вы уверены, что хотите удалить категорию "${category.name}"?`);
                    setShowDeleteModal(true);
                }
            };

            const confirmDeleteCategory = async () => {
                setShowDeleteModal(false);
                if (!categoryToDelete) return;

                if (categoryToDelete.tasksDue > 0) {
                    console.log("Невозможно удалить категорию с задачами.");
                    return;
                }

                try {
                    const categoryDocRef = doc(db, `artifacts/${appId}/public/data/categories`, categoryToDelete.id);
                    await deleteDoc(categoryDocRef);
                    setCategoryToDelete(null);
                } catch (error) {
                    console.error("Ошибка удаления категории:", error);
                    displayMessage("Ошибка удаления категории", `Ошибка при удалении категории: ${error.message}`);
                }
            };

            const handleAddCategory = async () => {
                if (!newCategoryName.trim()) {
                    displayMessage("Ошибка ввода", "Имя категории не может быть пустым.");
                    return;
                }
                setShowAddCategoryModal(false);
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), {
                        name: newCategoryName,
                        nextDueDate: 'НЕТ', // По умолчанию
                        tasksDue: 0, // Будет обновлено слушателем задач
                        tasksNext30Days: 0, // Будет обновлено слушателем задач
                    });
                    setNewCategoryName('');
                } catch (error) {
                    console.error("Ошибка добавления категории:", error);
                    displayMessage("Ошибка добавления категории", `Ошибка при добавлении категории: ${error.message}`);
                }
            };

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка категорий...</div>;
            }

            return (
                <div className="p-6">
                    <button
                        onClick={() => setShowAddCategoryModal(true)}
                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-200"
                    >
                        + Добавить новую категорию
                    </button>

                    <Modal
                        show={showDeleteModal}
                        title="Удалить категорию"
                        message={deleteMessage}
                        onClose={() => setShowDeleteModal(false)}
                        onConfirm={categoryToDelete?.tasksDue > 0 ? null : confirmDeleteCategory}
                        showCancel={categoryToDelete?.tasksDue === 0} // Показывать отмену только если tasksDue = 0
                        confirmText={categoryToDelete?.tasksDue > 0 ? 'ОК' : 'Удалить'}
                    />

                    <Modal
                        show={showAddCategoryModal}
                        title="Добавить новую категорию"
                        onClose={() => setShowAddCategoryModal(false)}
                        onConfirm={handleAddCategory}
                        confirmText="ОК"
                    >
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="categoryName">
                                Имя категории:
                            </label>
                            <input
                                type="text"
                                id="categoryName"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={newCategoryName}
                                onChange={(e) => setNewCategoryName(e.target.value)}
                                required
                            />
                        </div>
                    </Modal>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {categories.map((category) => (
                            <div key={category.id} className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold text-gray-800">{category.name}</h3>
                                    <button onClick={() => handleDeleteCategoryClick(category)} className="text-gray-500 hover:text-red-600 transition duration-200">
                                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p className="text-gray-600 text-sm mb-2">
                                    Срок выполнения: <span className={category.nextDueDate === 'НЕТ' ? 'font-medium' : new Date(category.nextDueDate) < new Date() ? 'text-red-500 font-bold' : 'font-medium'}>
                                        {category.nextDueDate === 'НЕТ' ? 'НЕТ' : category.nextDueDate}
                                        {new Date(category.nextDueDate) < new Date() && category.nextDueDate !== 'НЕТ' && <span className="ml-1 text-red-700">ПРОСРОЧЕНО</span>}
                                    </span>
                                </p>
                                <p className="text-gray-600 text-sm mb-2">Задач к выполнению: <span className="font-medium">{category.tasksDue}</span></p>
                                <p className="text-gray-600 text-sm mb-4">Задач в следующие 30 дней: <span className="font-medium">{category.tasksNext30Days}</span></p>
                                <button
                                    onClick={() => setCurrentPage('tasks', category.id, category.name)}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-200"
                                >
                                    Просмотреть
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Компонент задач (по категориям)
        const Tasks = ({ selectedCategoryId, selectedCategoryName, setCurrentPage, displayMessage }) => {
            const { db, userId } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddTaskModal, setShowAddTaskModal] = useState(false);
            const [newTask, setNewTask] = useState({ name: '', frequency: '', dueDate: '', category: selectedCategoryName || '' });
            const [categories, setCategories] = useState([]); // Для выбора категории для новой задачи

            useEffect(() => {
                if (!db || !userId) return;

                let tasksQueryRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                if (selectedCategoryId) {
                    tasksQueryRef = query(tasksQueryRef, where('category', '==', selectedCategoryName));
                }

                const unsubscribeTasks = onSnapshot(tasksQueryRef, (snapshot) => {
                    const fetchedTasks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    fetchedTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // Сортировка по сроку
                    setTasks(fetchedTasks);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения задач:", error);
                    setLoading(false);
                });

                const unsubscribeCategories = onSnapshot(collection(db, `artifacts/${appId}/public/data/categories`), (snapshot) => {
                    const fetchedCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        name: doc.data().name
                    }));
                    setCategories(fetchedCategories);
                }, (error) => {
                    console.error("Ошибка получения категорий для задач:", error);
                });

                return () => {
                    unsubscribeTasks();
                    unsubscribeCategories();
                };
            }, [db, userId, appId, selectedCategoryId, selectedCategoryName]);

            const handleAddTask = async () => {
                if (!newTask.name || !newTask.frequency || !newTask.dueDate || !newTask.category) {
                    displayMessage("Ошибка ввода", "Пожалуйста, заполните все поля.");
                    return;
                }
                setShowAddTaskModal(false);
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                        ...newTask,
                        done: false, // По умолчанию не выполнено
                        documentAttached: false, // По умолчанию нет документа
                    });
                    setNewTask({ name: '', frequency: '', dueDate: '', category: selectedCategoryName || '' });
                } catch (error) {
                    console.error("Ошибка добавления задачи:", error);
                    displayMessage("Ошибка добавления задачи", `Ошибка при добавлении задачи: ${error.message}`);
                }
            };

            const handleUploadDoc = async (taskId) => {
                displayMessage("Загрузка документа", "Функция загрузки/замены документа не реализована в этой демонстрации.");
                // Пример обновления поля documentAttached после успешной загрузки
                try {
                    const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
                    await updateDoc(taskDocRef, { documentAttached: true, documentUrl: 'https://example.com/mock-doc.pdf' });
                } catch (error) {
                    console.error("Error updating documentAttached status:", error);
                }
            };

            const handleMarkAsDone = async (task) => {
                try {
                    const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, task.id);
                    const originalDueDate = new Date(task.dueDate);
                    let newDueDate = new Date(originalDueDate);

                    // Обновление срока выполнения на основе частоты
                    switch (task.frequency) {
                        case 'Ежегодно':
                            newDueDate.setFullYear(newDueDate.getFullYear() + 1);
                            break;
                        case 'Ежеквартально':
                            newDueDate.setMonth(newDueDate.getMonth() + 3);
                            break;
                        case 'Каждые 3 года':
                            newDueDate.setFullYear(newDueDate.getFullYear() + 3);
                            break;
                        case 'Ежемесячно':
                            newDueDate.setMonth(newDueDate.getMonth() + 1);
                            break;
                        default:
                            newDueDate.setDate(newDueDate.getDate() + 30); // По умолчанию - ежемесячно
                    }

                    // Устанавливаем 'done' в false, чтобы задача снова появилась для следующего срока
                    await updateDoc(taskDocRef, {
                        done: false, // Задача "выполнена" и переходит к следующему циклу
                        dueDate: newDueDate.toISOString().split('T')[0], // Формат ГГГГ-ММ-ДД
                    });
                    displayMessage("Задача выполнена", "Задача отмечена как выполненная и срок обновлен.");
                } catch (error) {
                    console.error("Ошибка при отметке задачи как выполненной:", error);
                    displayMessage("Ошибка выполнения задачи", `Ошибка при отметке задачи как выполненной: ${error.message}`);
                }
            };

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка задач...</div>;
            }

            return (
                <div className="p-6">
                    <button
                        onClick={() => setShowAddTaskModal(true)}
                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-200"
                    >
                        + Добавить новую задачу
                    </button>

                    <Modal
                        show={showAddTaskModal}
                        title="Добавить новую задачу"
                        onClose={() => setShowAddTaskModal(false)}
                        onConfirm={handleAddTask}
                        confirmText="ОК"
                    >
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="taskName">
                                Имя задачи:
                            </label>
                            <input
                                type="text"
                                id="taskName"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={newTask.name}
                                onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="taskCategory">
                                Категория:
                            </label>
                            <select
                                id="taskCategory"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={newTask.category}
                                onChange={(e) => setNewTask({ ...newTask, category: e.target.value })}
                                required
                            >
                                <option value="">Выберите категорию</option>
                                {categories.map(cat => (
                                    <option key={cat.id} value={cat.name}>{cat.name}</option>
                                ))}
                            </select>
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="taskFrequency">
                                Частота:
                            </label>
                            <input
                                type="text"
                                id="taskFrequency"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={newTask.frequency}
                                onChange={(e) => setNewTask({ ...newTask, frequency: e.target.value })}
                                placeholder="Ежегодно, ежеквартально и т.д."
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="taskDueDate">
                                Срок выполнения:
                            </label>
                            <input
                                type="date"
                                id="taskDueDate"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={newTask.dueDate}
                                onChange={(e) => setNewTask({ ...newTask, dueDate: e.target.value })}
                                required
                            />
                        </div>
                    </Modal>

                    <div className="overflow-x-auto bg-white rounded-lg shadow">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Задача</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Частота</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Срок</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загрузить</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выполнено</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {tasks.map((task) => (
                                    <tr key={task.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{task.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{task.frequency}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span className={new Date(task.dueDate) < new Date() ? 'text-red-500' : ''}>
                                                {task.dueDate}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                            <button
                                                onClick={() => handleUploadDoc(task.id)}
                                                className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded-full text-xs"
                                            >
                                                {task.documentAttached ? 'Заменить PDF' : 'Прикрепить PDF'}
                                            </button>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <input
                                                type="checkbox"
                                                checked={task.done}
                                                onChange={() => handleMarkAsDone(task)}
                                                className="form-checkbox h-5 w-5 text-blue-600 rounded-md"
                                            />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Компонент документов (категории)
        const Documents = ({ setCurrentPage }) => {
            const { db, userId } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [docCategories, setDocCategories] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !userId) return;

                // Здесь будет агрегироваться данные из задач и их документов.
                // Для демонстрации используется упрощенная модель на основе коллекции 'documentCategories'.
                const unsubscribeDocCategories = onSnapshot(collection(db, `artifacts/${appId}/public/data/documentCategories`), (snapshot) => {
                    const fetchedDocCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setDocCategories(fetchedDocCategories);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения категорий документов:", error);
                    setLoading(false);
                });

                // Слушатель для подсчета документов по категориям
                const unsubscribeDocuments = onSnapshot(collection(db, `artifacts/${appId}/public/data/documents`), (snapshot) => {
                    const allDocuments = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setDocCategories(prevCategories => {
                        return prevCategories.map(category => {
                            const documentsInCategory = allDocuments.filter(doc => doc.category === category.name);
                            const documentTypesInCat = new Set(documentsInCategory.map(doc => doc.type));

                            return {
                                ...category,
                                documentTypesCount: documentTypesInCat.size,
                                filesCount: documentsInCategory.length,
                            };
                        });
                    });
                });

                return () => {
                    unsubscribeDocCategories();
                    unsubscribeDocuments();
                };
            }, [db, userId, appId]);

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка категорий документов...</div>;
            }

            return (
                <div className="p-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {docCategories.map((docCat) => (
                            <div key={docCat.id} className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <h3 className="text-xl font-semibold text-gray-800 mb-3">{docCat.name}</h3>
                                <p className="text-gray-600 text-sm mb-2">Типы документов: <span className="font-medium">{docCat.documentTypesCount || 0}</span></p>
                                <p className="text-gray-600 text-sm mb-4">Файлов: <span className="font-medium">{docCat.filesCount || 0}</span></p>
                                <button
                                    onClick={() => setCurrentPage('documentTypes', null, null, docCat.id, docCat.name)}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-200"
                                >
                                    Просмотреть
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Компонент документов (по задачам)
        const DocumentTypes = ({ selectedDocumentCategoryId, selectedDocumentCategoryName, setCurrentPage, displayMessage }) => {
            const { db, userId } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [documentTypes, setDocumentTypes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [docTypeToDelete, setDocTypeToDelete] = useState(null);
            const [deleteMessage, setDeleteMessage] = useState('');

            useEffect(() => {
                if (!db || !userId) return;

                let docTypesQueryRef = collection(db, `artifacts/${appId}/public/data/documentTypes`);
                if (selectedDocumentCategoryId) {
                    docTypesQueryRef = query(docTypesQueryRef, where('category', '==', selectedDocumentCategoryName));
                }

                const unsubscribeDocTypes = onSnapshot(docTypesQueryRef, (snapshot) => {
                    const fetchedDocTypes = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setDocumentTypes(fetchedDocTypes);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения типов документов:", error);
                    setLoading(false);
                });

                const unsubscribeDocuments = onSnapshot(collection(db, `artifacts/${appId}/public/data/documents`), (snapshot) => {
                    const allDocuments = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    setDocumentTypes(prevDocTypes => {
                        return prevDocTypes.map(docType => {
                            const documentsForType = allDocuments.filter(doc => doc.type === docType.name);
                            return {
                                ...docType,
                                documentsCount: documentsForType.length,
                            };
                        });
                    });
                });

                return () => {
                    unsubscribeDocTypes();
                    unsubscribeDocuments();
                };
            }, [db, userId, appId, selectedDocumentCategoryId, selectedDocumentCategoryName]);

            const handleDeleteDocTypeClick = (docType) => {
                setDocTypeToDelete(docType);
                if (docType.documentsCount > 0) {
                    setDeleteMessage("Чтобы удалить этот тип документа, необходимо удалить все его документы.");
                    setShowDeleteModal(true);
                } else {
                    setDeleteMessage(`Вы уверены, что хотите удалить тип документа "${docType.name}"?`);
                    setShowDeleteModal(true);
                }
            };

            const confirmDeleteDocType = async () => {
                setShowDeleteModal(false);
                if (!docTypeToDelete) return;

                if (docTypeToDelete.documentsCount > 0) {
                    console.log("Невозможно удалить тип документа с документами.");
                    return;
                }

                try {
                    const docTypeRef = doc(db, `artifacts/${appId}/public/data/documentTypes`, docTypeToDelete.id);
                    await deleteDoc(docTypeRef);
                    setDocTypeToDelete(null);
                } catch (error) {
                    console.error("Ошибка удаления типа документа:", error);
                    displayMessage("Ошибка удаления типа документа", `Ошибка при удалении типа документа: ${error.message}`);
                }
            };

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка типов документов...</div>;
            }

            return (
                <div className="p-6">
                    <Modal
                        show={showDeleteModal}
                        title="Удалить тип документа"
                        message={deleteMessage}
                        onClose={() => setShowDeleteModal(false)}
                        onConfirm={docTypeToDelete?.documentsCount > 0 ? null : confirmDeleteDocType}
                        showCancel={docTypeToDelete?.documentsCount === 0}
                        confirmText={docTypeToDelete?.documentsCount > 0 ? 'ОК' : 'Удалить'}
                    />

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {documentTypes.map((docType) => (
                            <div key={docType.id} className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold text-gray-800">{docType.name}</h3>
                                    <button onClick={() => handleDeleteDocTypeClick(docType)} className="text-gray-500 hover:text-red-600 transition duration-200">
                                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p className="text-gray-600 text-sm mb-4">Документов: <span className="font-medium">{docType.documentsCount || 0}</span></p>
                                <button
                                    onClick={() => setCurrentPage('documentArchive', null, null, null, null, docType.id, docType.name)}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-200"
                                >
                                    Просмотреть
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Компонент архива документов
        const DocumentArchive = ({ selectedDocumentTypeId, selectedDocumentTypeName, displayMessage }) => {
            const { db, userId } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [documents, setDocuments] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !userId) return;

                let documentsQueryRef = collection(db, `artifacts/${appId}/public/data/documents`);
                if (selectedDocumentTypeId) {
                    documentsQueryRef = query(documentsQueryRef, where('type', '==', selectedDocumentTypeName));
                }

                const unsubscribe = onSnapshot(documentsQueryRef, (snapshot) => {
                    const fetchedDocuments = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    fetchedDocuments.sort((a, b) => new Date(b.uploadedDate) - new Date(a.uploadedDate)); // Сортировка по новейшим
                    setDocuments(fetchedDocuments);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения документов:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, appId, selectedDocumentTypeId, selectedDocumentTypeName]);

            const handleDownload = (documentUrl, filename) => {
                if (documentUrl) {
                    displayMessage("Загрузка файла", `Начата загрузка файла: ${filename}.`);
                    window.open(documentUrl, '_blank'); // Открыть в новой вкладке
                } else {
                    displayMessage("Ошибка", "Ссылка для скачивания недоступна.");
                }
            };

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка архива документов...</div>;
            }

            return (
                <div className="p-6">
                    <div className="overflow-x-auto bg-white rounded-lg shadow">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя файла</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Предоставлено</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загружено</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Скачать</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {documents.map((doc) => (
                                    <tr key={doc.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{doc.filename}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{doc.suppliedBy}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{doc.uploadedDate}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                            <button
                                                onClick={() => handleDownload(doc.url, doc.filename)}
                                                className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded-full text-xs"
                                            >
                                                Скачать
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Компонент пользователей (только для администраторов)
        const Users = ({ displayMessage }) => {
            const { db, userId, isAdmin } = useContext(FirebaseContext);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [userToDelete, setUserToDelete] = useState(null);
            const [showInviteUserModal, setShowInviteUserModal] = useState(false);
            const [inviteEmail, setInviteEmail] = useState('');
            const [inviteAdminStatus, setInviteAdminStatus] = useState(false);
            const [message, setMessage] = useState('');

            useEffect(() => {
                if (!db || !userId || !isAdmin) {
                    setLoading(false);
                    return;
                }

                // Получение пользователей из публичной коллекции (или коллекции, доступной для чтения администраторам)
                // Для безопасности в реальном приложении потребуются специальные правила Firestore.
                const q = query(collection(db, `artifacts/${appId}/public/data/users`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedUsers = snapshot.docs.map(d => ({
                        id: d.id,
                        ...d.data()
                    }));
                    setUsers(fetchedUsers);
                    setLoading(false);
                }, (error) => {
                    console.error("Ошибка получения пользователей:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, isAdmin, appId]);

            const toggleAdminStatus = async (user) => {
                if (!isAdmin) return; // Только администраторы могут переключать
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.id);
                    await updateDoc(userDocRef, { isAdmin: !user.isAdmin });
                } catch (error) {
                    console.error("Ошибка переключения статуса администратора:", error);
                    displayMessage("Ошибка администратора", `Ошибка при изменении статуса администратора: ${error.message}`);
                }
            };

            const handleDeleteUserClick = (user) => {
                setUserToDelete(user);
                setShowDeleteModal(true);
            };

            const confirmDeleteUser = async () => {
                setShowDeleteModal(false);
                if (!userToDelete) return;

                try {
                    // В реальной настройке Firebase удаление пользователя из Auth отдельно
                    // от удаления его профиля Firestore. Это имитирует удаление профиля.
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userToDelete.id);
                    await deleteDoc(userDocRef);
                    setUserToDelete(null);
                    setMessage(`Пользователь ${userToDelete.email} удален.`);
                } catch (error) {
                    console.error("Ошибка удаления пользователя:", error);
                    setMessage(`Ошибка при удалении пользователя: ${error.message}`);
                }
            };

            const handleInviteUser = async () => {
                if (!inviteEmail.trim()) {
                    setMessage("Адрес электронной почты не может быть пустым.");
                    return;
                }
                setShowInviteUserModal(false);
                setMessage('');
                try {
                    // В реальном приложении это будет включать отправку пригласительного письма
                    // или создание пользователя с временным паролем через Firebase Admin SDK.
                    // Для этой демонстрации мы имитируем создание записи пользователя в Firestore.
                    await addDoc(collection(db, `artifacts/${appId}/public/data/users`), {
                        email: inviteEmail,
                        firstName: '',
                        lastName: '',
                        isAdmin: inviteAdminStatus,
                        invitedAt: new Date().toISOString(),
                        status: 'pending_invitation' // Пример статуса
                    });
                    setInviteEmail('');
                    setInviteAdminStatus(false);
                    setMessage(`Приглашение отправлено ${inviteEmail}.`);
                } catch (error) {
                    console.error("Ошибка при приглашении пользователя:", error);
                    setMessage(`Ошибка при приглашении пользователя: ${error.message}`);
                }
            };

            if (loading) {
                return <div className="text-center text-gray-500">Загрузка пользователей...</div>;
            }

            if (!isAdmin) {
                return <div className="text-center text-red-500">У вас нет разрешения на просмотр этой страницы.</div>;
            }

            return (
                <div className="p-6">
                    <button
                        onClick={() => setShowInviteUserModal(true)}
                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-200"
                    >
                        + Добавить нового пользователя
                    </button>
                    {message && <p className="text-center text-sm mb-4 text-green-600">{message}</p>}

                    <Modal
                        show={showDeleteModal}
                        title="Удалить пользователя"
                        message={`Вы уверены, что хотите удалить пользователя "${userToDelete?.email}"?`}
                        onClose={() => setShowDeleteModal(false)}
                        onConfirm={confirmDeleteUser}
                        confirmText="Удалить"
                        cancelText="Отмена"
                    />

                    <Modal
                        show={showInviteUserModal}
                        title="Пригласить нового пользователя"
                        onClose={() => setShowInviteUserModal(false)}
                        onConfirm={handleInviteUser}
                        confirmText="Пригласить"
                    >
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="inviteEmail">
                                Адрес электронной почты
                            </label>
                            <input
                                type="email"
                                id="inviteEmail"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500"
                                value={inviteEmail}
                                onChange={(e) => setInviteEmail(e.target.value)}
                                required
                            />
                        </div>
                        <div className="mb-4 flex items-center">
                            <input
                                type="checkbox"
                                id="inviteAdmin"
                                className="form-checkbox h-5 w-5 text-blue-600 rounded"
                                checked={inviteAdminStatus}
                                onChange={(e) => setInviteAdminStatus(e.target.checked)}
                            />
                            <label className="ml-2 text-gray-700 text-sm font-bold" htmlFor="inviteAdmin">
                                Администратор
                            </label>
                        </div>
                    </Modal>

                    <div className="overflow-x-auto bg-white rounded-lg shadow">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Фамилия</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Электронная почта</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Админ</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Удалить</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {users.map((user) => (
                                    <tr key={user.id}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.lastName || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.firstName || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.email}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <input
                                                type="checkbox"
                                                checked={user.isAdmin || false}
                                                onChange={() => toggleAdminStatus(user)}
                                                className="form-checkbox h-5 w-5 text-blue-600 rounded-md"
                                                disabled={!isAdmin} // Только администратор может изменять
                                            />
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <button
                                                onClick={() => handleDeleteUserClick(user)}
                                                className="text-red-600 hover:text-red-800 transition duration-200"
                                                disabled={!isAdmin} // Только администратор может удалять
                                            >
                                                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
